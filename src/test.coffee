

'use strict'

############################################################################################################
CND                       = require 'cnd'
rpr                       = CND.rpr
badge                     = 'BUZHASH'
debug                     = CND.get_logger 'debug',     badge
alert                     = CND.get_logger 'alert',     badge
whisper                   = CND.get_logger 'whisper',   badge
warn                      = CND.get_logger 'warn',      badge
help                      = CND.get_logger 'help',      badge
urge                      = CND.get_logger 'urge',      badge
info                      = CND.get_logger 'info',      badge
echo                      = CND.echo.bind CND
#...........................................................................................................
Buzhash                   = require '..'
CRYPTO                    = require 'crypto'
hash_name                 = 'sha1'

#-----------------------------------------------------------------------------------------------------------
new_buzhash = -> new Buzhash 32

#-----------------------------------------------------------------------------------------------------------
compress = ( chunks, buffer ) ->
  sha       = CRYPTO.createHash hash_name
  buzhash   = new_buzhash()
  pattern   = ( 2 ** 5 ) - 1
  # pattern   = 0b10101
  R         = []
  i_prv     = 0
  i         = 0
  echo()
  #.........................................................................................................
  next = ->
    ch            = ( sha.digest 'hex' ).slice 0, 17
    text          = ( buffer.slice i_prv, i ).toString 'utf-8'
    is_new        = not chunks[ ch ]?
    chunks[ ch ]  = text if is_new
    R.push ch
    sha           = CRYPTO.createHash hash_name
    ### Reset Buzhash; if we'd go on using the old one, synchronization would suffer: ###
    buzhash       = new_buzhash()
    i_prv         = i
    #.......................................................................................................
    color = if is_new then CND.lime else CND.grey
    echo ( CND.grey ch ), ( color rpr text )
  #.........................................................................................................
  loop
    state = buzhash.update buffer.readInt8 i
    sha.update buffer.slice i, i + 1
    # next() if ( buffer.readInt8 i ) % 100 is 0
    next() if ( state & pattern ) is 0
    i++
    if i >= buffer.length
      next() if i - i_prv > 1
      break
  #.........................................................................................................
  return R

#-----------------------------------------------------------------------------------------------------------
ch_from_text = ( text ) ->
  sha       = CRYPTO.createHash hash_name
  sha.update new Buffer text
  return ( sha.digest 'hex' ).slice 0, 17

#-----------------------------------------------------------------------------------------------------------
test = ->
  chunks = {}
  texts = [
    "So viele komplizierte Verwandtschaftsgeschichten, ich kenn mich bald nicht mehr aus"
    "XXX So viele komplizierte Verwandtschaftsgeschichten, ich kenn mich bald nicht mehr aus"
    "So viele kompliziertere Verwandtschaftsgeschichten, ich kenn mich bald nicht mehr aus"
    "So viele kompliziertere Verwandtschaftsgeschichten"
    "So viele extrem komplizierte Verwandtschaftsgeschichten"
    "So viele sehr viel kompliziertere Verwandtschaftsgeschichten"
    "So viele sehr viel kompliziertere und interessante Verwandtschaftsgeschichten"
    "Das sind viele sehr viel kompliziertere und interessante Verwandtschaftsgeschichten"
    "So viele komplizierte Verwandtschaftsgeschichten"
    # '3.14159265358979323846264338327950288419716939937510582097494459230781640628620899862803482534211706798214808651328230664709384460955058223172535940812848111745028410270193852110555964462294895493038196442881097566593344612847564823378678316527120190914564856692346034861045432664821339360726024914127372458700660631558817488152092096282925409171536436789259036001133053054882046652138414695194151160943305727036575959195309218611738193261179310511854807446237996274956735188575272489122793818301194912983367336244065664308602139494639522473719070217986094370277053921717629317675238467481846766940513200056812714526356082778577134275778960917363717872146844090122495343014654958537105079227968925892354201995611212902196086403441815981362977477130996051870721134999999837297804995105973173281609631859502445945534690830264252230825334468503526193118817101000313783875288658753320838142061717766914730359825349042875546873115956286388235378759375195778185778053217122680661300192787661119590921642019893809525720106548586327886593615338182796823030195203530185296899577362259941389124972177528347913151557485724245415069595082953311686172785588907509838175463746493931925506040092770167113900984882401285836160356370766010471018194295559619894676783744944825537977472684710404753464620804668425906949129331367702898915210475216205696602405803815019351125338243003558764024749647326391419927260426992279678235478163600934172164121992458631503028618297455570674983850549458858692699569092721079750930295532116534498720275596023648066549911988183479775356636980742654252786255181841757467289097777279380008164706001614524919217321721477235014144197356854816136115735255213347574184946843852332390739414333454776241686251898356948556209921922218427255025425688767179049460165346680498862723279178608578438382796797668145410095388378636095068006422512520511739298489608412848862694560424196528502221066118630674427862203919494504712371378696095636437191728746776465757396241389086583264599581339047802759009946576407895126946839835259570982582262052248940772671947826848260147699090264013639443745530506820349625245174939965143142980919065925093722169646151570985838741059788595977297549893016175392846813826868386894277415599185592524595395943104997252468084598727364469584865383673622262609912460805124388439045124413654976278079771569143599770012961608944169486855584840635342207222582848864815845602850601684273945226746767889525213852254995466672782398645659611635488623057745649803559363456817432411251507606947945109659609402522887971089314566913686722874894056010150330861792868092087476091782493858900971490967598526136554978189312978482168299894872265880485756401427047755513237964145152374623436454285844479526586782105114135473573952311342716610213596953623144295248493718711014576540359027993440374200731057853906219838744780847848968332144571386875194350643021845319104848100537061468067491927819119793995206141966342875444064374512371819217999839101591956181467514269123974894090718649423196156794520809514655022523160388193014209376213785595663893778708303906979207734672218256259966150142150306803844773454920260541466592520149744285073251866600213243408819071048633173464965145390579626856100550810665879699816357473638405257145910289706414011097120628043903975951567715770042033786993600723055876317635'
    ]
  #.........................................................................................................
  texts_length      = 0
  chunks_length     = 0
  assemblies_length = 0
  assemblies        = {}
  #.........................................................................................................
  for text in texts
    buffer            = new Buffer text
    texts_length     += buffer.length
    ch                = ch_from_text text
    assembly          = compress chunks, buffer
    assemblies[ ch ]  = assembly
  #.........................................................................................................
  for ch, chunk of chunks
    chunks_length += ( new Buffer chunk ).length
    info ch, rpr chunk
  #.........................................................................................................
  for ch, assembly of assemblies
    assemblies_length  += assembly.length * 17
    # urge ch, assembly.join ' '
  #.........................................................................................................
  chunk_count       = ( Object.keys chunks ).length
  chunks_length_avg = chunks_length / chunk_count
  storage_length    = assemblies_length + chunks_length
  compression       = storage_length / texts_length
  #.........................................................................................................
  urge "text count:                     ", texts.length
  urge "chunks count:                   ", chunk_count
  urge "average chunks length:          ", chunks_length_avg
  urge "length of all texts:            ", texts_length
  urge "length of all chunks:           ", chunks_length
  urge "length of all assemblies:       ", assemblies_length
  urge "storage length:                 ", storage_length
  urge "compression (storage / input):  ", compression

test()











